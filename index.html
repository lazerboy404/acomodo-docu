<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Protocolos</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #0a192f; color: #e6f1ff; margin: 0; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; user-select: none; }
        .container { background-color: #112240; padding: 25px; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); width: 100%; max-width: 500px; text-align: center; border: 1px solid #233554; position: relative; }
        h1 { margin: 0 0 15px 0; font-size: 1.5rem; color: #fff; text-shadow: 0 0 10px rgba(0,210,255,0.3); }

        /* BUTTONS & INPUTS */
        .btn-summary { background: #1d2d50; color: #00e5ff; border: 1px solid #233554; padding: 12px 15px; border-radius: 20px; cursor: pointer; font-size: 1rem; margin-bottom: 20px; font-weight: bold; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-summary:hover { background: #233554; box-shadow: 0 0 15px rgba(0,229,255,0.2); }
        .search-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; background: transparent; border: 1px solid #233554; color: #8892b0; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: #00e5ff; color: #0a192f; border-color: #00e5ff; box-shadow: 0 0 10px rgba(0, 229, 255, 0.4); }
        input, select, textarea { width: 100%; padding: 15px; font-size: 1.2rem; background-color: #1d2d50; color: #00e5ff; border: 2px solid #233554; border-radius: 8px; text-align: center; margin-bottom: 10px; box-sizing: border-box; }
        input:focus, select:focus, textarea:focus { border-color: #00e5ff; outline: none; background-color: #172a45; }
        
        /* RESULT CARD */
        .result-card { display: none; margin-top: 20px; padding: 20px; border: 2px solid #00e5ff; border-radius: 12px; background-color: #112240; box-shadow: 0 0 20px rgba(0,229,255,0.1); }
        .result-card.show { display: block; animation: slideUp 0.3s; }
        .result-card.warning-mode { border-color: #ff9800; box-shadow: 0 0 30px rgba(255, 152, 0, 0.4); }
        .lote-header { font-size: 1.6rem; font-weight: bold; color: #fff; margin-bottom: 10px; }
        .pos-badge { font-size: 3rem; font-weight: 800; color: #00e5ff; display: block; line-height: 1; margin: 10px 0; word-break: break-all; }
        .warning-mode .pos-badge { color: #ff9800; }
        .label { font-size: 0.8rem; color: #8892b0; text-transform: uppercase; }
        
        .neighbors-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; margin-bottom: 20px; border-top: 1px solid #233554; padding-top: 15px; }
        .neighbor-box { background: #1d2d50; padding: 10px; border-radius: 8px; font-size: 0.85rem; }
        .neighbor-val { color: #fff; font-weight: bold; word-break: break-all; font-size: 1.2rem; }
        
        .obs-container { border-top: 1px solid #233554; padding-top: 15px; text-align: left; }
        .buttons-row { display: flex; gap: 10px; margin-top: 8px; }
        .btn-save { background: #00e5ff; color: #0a192f; border: none; padding: 10px; border-radius: 5px; width: 100%; font-weight: bold; cursor: pointer; }
        .btn-delete { background: #1d2d50; color: #ff5252; border: 1px solid #ff5252; padding: 10px; border-radius: 5px; width: 60%; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .save-indicator { font-size: 0.75rem; color: #00ff88; margin-top: 5px; text-align: center; height: 1em; }
        
        .batch-alert { display: none; background-color: #ff9800; color: #000; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; animation: pulse 1s infinite; border: 2px solid #fff; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 25, 47, 0.98); z-index: 100; display: none; justify-content: center; padding-top: 20px; }
        .modal-content { background: #112240; width: 95%; max-width: 950px; padding: 20px; border-radius: 10px; border: 1px solid #233554; margin-bottom: 40px; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-close { font-size: 1.5rem; cursor: pointer; color: #fff; margin-left: 15px;}
        .btn-excel { background: #107c41; color: white; border: none; padding: 6px 12px; border-radius: 5px; font-size: 0.85rem; cursor: pointer; font-weight: bold; }
        .btn-report-main { background: #233554; border: 1px solid #00e5ff; color: #00e5ff; margin-right: 10px; }
        .btn-report-main:hover { background: #00e5ff; color: #0a192f; }

        /* TABLA RESUMEN */
        #viewTable { overflow-y: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th { text-align: center; color: #00e5ff; border-bottom: 2px solid #233554; padding: 10px 5px; position: sticky; top: 0; background: #112240; z-index: 2; }
        td { padding: 10px 5px; border-bottom: 1px solid #1d2d50; color: #ccd6f6; vertical-align: middle; }
        .cell-id { font-family: monospace; color: #fff; }
        
        /* SWITCH EST√ÅNDAR (VERDE) */
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; margin: 0 auto; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #1d2d50; border: 1px solid #233554; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background-color: #8892b0; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: rgba(0, 255, 136, 0.2); border-color: #00ff88; }
        input:checked + .slider:before { transform: translateX(16px); background-color: #00ff88; }
        .switch-label { font-size: 0.6rem; font-weight: bold; color: #00ff88; display: block; margin-top: 2px; }

        /* SWITCH INT (NARANJA NE√ìN) - AQU√ç EST√Å EL CAMBIO DE COLOR */
        input.int-check:checked + .slider { 
            background-color: rgba(255, 152, 0, 0.2); 
            border-color: #ff9800; 
        }
        input.int-check:checked + .slider:before { 
            background-color: #ff9800; 
            box-shadow: 0 0 10px #ff9800; 
            transform: translateX(16px);
        }
        .switch-label.int-label { 
            color: #ff9800; 
            text-shadow: 0 0 5px rgba(255, 152, 0, 0.5); 
        }

        .status-cell { text-align: center; border-right: 1px solid #233554; min-width: 60px; }
        .row-finished-main td:not(.status-cell) { color: #00ff88 !important; }

        .obs-badge { display: inline-block; background: #233554; color: #8892b0; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; }
        .btn-obs-active { background: #ff5252; color: white; border: none; padding: 4px 10px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .btn-mini { background: none; border: 1px solid #233554; color: #8892b0; border-radius: 4px; cursor: pointer; font-size: 0.75rem; padding: 4px 8px; }

        /* LISTA DE FLUJO (CONTENEDOR RESTAURADO) */
        #viewList { display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .view-list-header { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; border-bottom: 1px solid #233554; padding-bottom: 10px; }
        
        .flow-container { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; padding: 10px 5px; flex-grow: 1; }
        
        .flow-row { display: grid; grid-template-columns: 90px 1fr 100px; align-items: center; background: #172a45; padding: 12px 10px; border-radius: 8px; border-left: 6px solid #233554; cursor: pointer; transition: all 0.1s; column-gap: 15px; }
        .flow-row:nth-child(even) { background-color: #112240; }
        .flow-row:not(.checked):hover { transform: scale(1.01); border-left-color: #00e5ff; }
        
        .flow-row.checked { background-color: rgba(0, 230, 118, 0.15) !important; border-left: 8px solid #00e676 !important; box-shadow: 0 0 10px rgba(0, 230, 118, 0.1); }
        .flow-row.checked .flow-pos, .flow-row.checked .flow-id, .flow-row.checked .flow-date { color: #00e676 !important; text-shadow: 0 0 5px rgba(0, 230, 118, 0.4); }

        .flow-pos { font-size: 2.2rem; font-weight: 900; color: #00e5ff; text-align: center; line-height: 1; }
        .flow-id { font-size: 1.5rem; font-weight: 800; color: #ffffff; word-break: break-all; letter-spacing: 0.5px; }
        .flow-date { font-size: 0.85rem; color: #ffffff; font-weight: bold; text-align: right; }

        .obs-card { background: rgba(255, 82, 82, 0.1); border: 1px solid #ff5252; border-radius: 8px; padding: 15px; margin-bottom: 10px; text-align: left; }
        .obs-id-title { color: #ff5252; font-weight: bold; font-size: 1.2rem; }
        .obs-text { color: #ffebee; margin-top: 5px; white-space: pre-wrap; }

        .btn-back { background: #233554; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; flex-grow: 1; }
        .btn-action { background: #1d2d50; color: #fff; border: 1px solid #fff; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; min-width: 170px; justify-content: center; }
        .btn-action.active-sort { background: #00e5ff; color: #0a192f; border-color: #00e5ff; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>üìç Localizador</h1>
    
    <button class="btn-summary" onclick="toggleSummary()">üìã Resumen / Reporte </button>
    
    <div id="loading" class="status-bar status-loading">üì° Conectando a Base de Datos...</div>
    
    <div id="appInterface" style="display:none; width: 100%;">
        
        <div class="search-tabs">
            <button id="tabID" class="tab-btn active" onclick="switchMode('id')">üîç Por ID</button>
            <button id="tabPos" class="tab-btn" onclick="switchMode('pos')">üî¢ Por Posici√≥n</button>
        </div>

        <div id="modeID">
            <input type="text" id="searchInput" placeholder="Escribe ID (ej. 26964)" autocomplete="off">
        </div>

        <div id="modePos" style="display:none;">
            <select id="loteSelect" onchange="searchByPos()">
                <option value="" disabled selected>-- Selecciona Lote --</option>
            </select>
            <input type="number" id="posInput" placeholder="N¬∞ Posici√≥n (ej. 50)" oninput="searchByPos()">
        </div>

        <div id="errorMsg" class="error-msg">‚ùå NO ENCONTRADO</div>
        <div id="batchAlert" class="batch-alert">‚ö†Ô∏è ATENCI√ìN: ¬°CAMBIASTE DE LOTE!</div>

        <div id="result" class="result-card">
            <div class="label">Lote:</div>
            <div class="lote-header" id="resLote">--</div>
            
            <div class="label" id="lblMainResult">Posici√≥n en Archivo:</div>
            <span class="pos-badge" id="resPos">--</span>
            
            <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 5px;" id="resOriginalId"></div>
            
            <div class="neighbors-grid">
                <div class="neighbor-box">
                    <div class="neighbor-title">‚¨ÖÔ∏è ANTERIOR</div>
                    <div class="neighbor-val" id="resPrev">--</div>
                </div>
                <div class="neighbor-box">
                    <div class="neighbor-title">SIGUIENTE ‚û°Ô∏è</div>
                    <div class="neighbor-val" id="resNext">--</div>
                </div>
            </div>

            <div class="obs-container">
                <div class="label" style="margin-bottom: 5px;">Observaciones (Nube):</div>
                <textarea id="txtObs" placeholder="Agregar comentario..."></textarea>
                <div class="buttons-row">
                    <button class="btn-save" onclick="guardarComentario()">üíæ Guardar</button>
                    <button class="btn-delete" onclick="borrarComentario()">üóëÔ∏è Eliminar</button>
                </div>
                <div id="saveIndicator" class="save-indicator"></div>
            </div>
        </div>
    </div>
</div>

<div id="summaryModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <h2 style="color: #fff; margin:0;" id="modalTitle">Resumen</h2>
                <div style="display:flex; gap:5px;">
                    <button id="btnGeneralReport" class="btn-excel btn-report-main" onclick="descargarReporteGeneral()">üìä Descargar Avance</button>
                    <button id="btnObsReport" class="btn-excel" onclick="descargarReporteObservaciones()">üì• Descargar Observaciones</button>
                </div>
            </div>
            <span class="modal-close" onclick="closeModal()">&times;</span>
        </div>
        
        <div id="viewTable">
            <table>
                <thead>
                    <tr>
                        <th class="status-cell">Estado</th>
                        <th class="status-cell">INT</th>
                        <th>Lote</th>
                        <th>Inicio</th>
                        <th>Fin</th>
                        <th>Cant.</th>
                        <th>Obs.</th>
                        <th>Ver IDs</th>
                    </tr>
                </thead>
                <tbody id="summaryTableBody"></tbody>
            </table>
        </div>

        <div id="viewList">
            <div class="view-list-header">
                <button class="btn-back" onclick="backToTable()">‚¨ÖÔ∏è Regresar</button>
                <button id="btnSortDate" class="btn-action" onclick="toggleSortDate()">üìÖ Orden Original</button>
                <button id="btnDownloadLote" class="btn-action" onclick="descargarListaLote()">üì• Descargar lista</button>
            </div>
            <div id="flowContainer" class="flow-container"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyB-J-t0a8snfze_ITf2ev5gTfZunqH2CfE",
      authDomain: "organizar-carpetas-2ede2.firebaseapp.com",
      projectId: "organizar-carpetas-2ede2",
      storageBucket: "organizar-carpetas-2ede2.firebasestorage.app",
      messagingSenderId: "166847054646",
      appId: "1:166847054646:web:2227ce6d8b60eaf9d7e997",
      measurementId: "G-ZEEXQQ077C"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const JSON_URL = 'https://raw.githubusercontent.com/lazerboy404/acomodo-docu/main/base-angela.json';
    
    let dbIndex = {};       
    let lotesGlobal = {};
    let obsData = [];
    let currentId = null;   
    let currentLoteName = null;
    let currentViewLote = null;
    let currentMode = 'id';
    let lastLoteChecked = null;
    let sortState = 0; 
    let isDragging = false; 

    window.onload = async () => {
        try {
            const response = await fetch(JSON_URL);
            const data = await response.json();
            procesarEstructura(data);
            activarListeners(); 
            document.getElementById('loading').style.display = 'none';
            document.getElementById('appInterface').style.display = 'block';
            document.addEventListener('keydown', handleKeyboardNav);
            document.addEventListener('mouseup', () => { isDragging = false; });
            document.addEventListener('touchend', () => { isDragging = false; });
        } catch (error) {
            console.error(error);
            document.getElementById('loading').innerHTML = `<span style="color:#ff5252">‚ùå ERROR DE RED</span>`;
        }
    };

    function handleKeyboardNav(e) {
        const viewList = document.getElementById('viewList');
        if (viewList.style.display !== 'flex') return;
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') e.preventDefault();

        const container = document.getElementById('flowContainer');
        const rows = Array.from(container.getElementsByClassName('flow-row'));
        if (rows.length === 0) return;

        let lastCheckedIndex = -1;
        for (let i = rows.length - 1; i >= 0; i--) {
            if (rows[i].classList.contains('checked')) {
                lastCheckedIndex = i;
                break; 
            }
        }

        let nextRow = null;
        if (e.key === 'ArrowDown') {
            if (lastCheckedIndex === -1) nextRow = rows[0]; 
            else if (lastCheckedIndex < rows.length - 1) nextRow = rows[lastCheckedIndex + 1];
        } else if (e.key === 'ArrowUp') {
            if (lastCheckedIndex > 0) {
                nextRow = rows[lastCheckedIndex - 1];
                nextRow.scrollIntoView({ block: 'center', behavior: 'smooth' });
                return; 
            }
        }

        if (nextRow) {
            markRow(nextRow); 
            nextRow.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }
    }

    function procesarEstructura(jsonArray) {
        lotesGlobal = {};
        jsonArray.forEach(item => {
            const lote = item.Lote || "SIN_LOTE";
            if (!lotesGlobal[lote]) lotesGlobal[lote] = { items: [], terminado: false, terminado_int: false };
            lotesGlobal[lote].items.push(item);
        });

        const select = document.getElementById('loteSelect');
        const nombresLotes = Object.keys(lotesGlobal).sort();
        
        nombresLotes.forEach(nombre => {
            const option = document.createElement("option");
            option.value = nombre;
            option.text = nombre;
            select.appendChild(option);
            
            const items = lotesGlobal[nombre].items;
            items.forEach((item, index) => {
                const idFull = item.id_bct ? item.id_bct.trim().toUpperCase() : null;
                if (idFull) {
                    const info = {
                        lote: nombre,
                        posicion: index + 1,
                        indexArray: index,
                        extra: item.Etiqueta || "",
                        idReal: idFull,
                        fecha: item["Fecha Alta"] || ""
                    };
                    dbIndex[idFull] = info;
                    if (idFull.startsWith("MC")) dbIndex[idFull.replace("MC", "")] = info;
                }
            });
        });
        generarTablaResumen();
    }

    function activarListeners() {
        db.collection("estados_lotes").onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const loteName = change.doc.id;
                const data = change.doc.data();
                if (lotesGlobal[loteName]) {
                    lotesGlobal[loteName].terminado = data.terminado;
                    lotesGlobal[loteName].terminado_int = data.terminado_int || false; 
                }
            });
            generarTablaResumen();
        });
        db.collection("observaciones").onSnapshot((snapshot) => {
            obsData = [];
            snapshot.forEach(doc => { let obj = doc.data(); obj.id = doc.id; obsData.push(obj); });
            generarTablaResumen();
        });
    }

    // --- INTERFAZ ---
    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('result').classList.remove('show');
        document.getElementById('errorMsg').style.display = 'none';
        document.getElementById('batchAlert').style.display = 'none';
        
        if(mode === 'id') {
            document.getElementById('modeID').style.display = 'block';
            document.getElementById('modePos').style.display = 'none';
            document.getElementById('tabID').classList.add('active');
            document.getElementById('tabPos').classList.remove('active');
            document.getElementById('searchInput').focus();
        } else {
            document.getElementById('modeID').style.display = 'none';
            document.getElementById('modePos').style.display = 'block';
            document.getElementById('tabID').classList.remove('active');
            document.getElementById('tabPos').classList.add('active');
        }
    }

    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', async (e) => {
        const query = e.target.value.trim().toUpperCase();
        if (query.length === 0) { 
            document.getElementById('result').classList.remove('show'); 
            document.getElementById('batchAlert').style.display = 'none';
            return; 
        }
        const match = dbIndex[query];
        renderResult(match);
    });

    function searchByPos() {
        const lote = document.getElementById('loteSelect').value;
        const pos = parseInt(document.getElementById('posInput').value);
        if (!lote || !pos) return;

        const items = lotesGlobal[lote].items;
        if (pos > 0 && pos <= items.length) {
            const item = items[pos - 1];
            const match = {
                lote: lote, posicion: pos, indexArray: pos - 1,
                extra: item.Etiqueta || "", idReal: item.id_bct
            };
            renderResult(match);
        } else {
            document.getElementById('result').classList.remove('show');
            document.getElementById('errorMsg').style.display = 'block';
            document.getElementById('errorMsg').textContent = "‚ùå Posici√≥n fuera de rango";
        }
    }

    function renderResult(match) {
        const resultCard = document.getElementById('result');
        const errorMsg = document.getElementById('errorMsg');
        const alertBox = document.getElementById('batchAlert');

        if (match) {
            currentId = match.idReal;
            currentLoteName = match.lote;

            if (lastLoteChecked !== null && lastLoteChecked !== match.lote) {
                alertBox.style.display = "block";
                resultCard.classList.add("warning-mode");
                alertBox.textContent = `‚ö†Ô∏è ¬°ATENCI√ìN! CAMBIO DE LOTE: DE ${lastLoteChecked} A ${match.lote}`;
            } else {
                alertBox.style.display = "none";
                resultCard.classList.remove("warning-mode");
            }
            lastLoteChecked = match.lote;

            document.getElementById('resLote').textContent = match.lote;
            
            if (currentMode === 'id') {
                document.getElementById('lblMainResult').textContent = "Posici√≥n en Archivo:";
                document.getElementById('resPos').textContent = "#" + match.posicion;
                document.getElementById('resOriginalId').textContent = "ID: " + match.idReal + " " + match.extra;
            } else {
                document.getElementById('lblMainResult').textContent = "ID Encontrado:";
                document.getElementById('resPos').textContent = match.idReal; 
                document.getElementById('resOriginalId').textContent = "Posici√≥n: #" + match.posicion;
            }
            
            const lista = lotesGlobal[match.lote].items;
            const idx = match.indexArray;
            document.getElementById('resPrev').textContent = (idx > 0) ? lista[idx-1].id_bct : "(Inicio)";
            document.getElementById('resNext').textContent = (idx < lista.length-1) ? lista[idx+1].id_bct : "(Fin)";

            document.getElementById('txtObs').value = "Cargando...";
            db.collection("observaciones").doc(currentId).get().then((doc) => {
                if (doc.exists) document.getElementById('txtObs').value = doc.data().texto;
                else document.getElementById('txtObs').value = "";
            });

            errorMsg.style.display = 'none';
            resultCard.classList.add('show');
        } else {
            resultCard.classList.remove('show');
            alertBox.style.display = "none";
            errorMsg.style.display = 'block';
            errorMsg.textContent = "‚ùå NO ENCONTRADO";
        }
    }

    function guardarComentario() {
        const txt = document.getElementById('txtObs').value;
        const indicador = document.getElementById('saveIndicator');
        if(!currentId) return;
        indicador.textContent = "Guardando...";
        db.collection("observaciones").doc(currentId).set({
            texto: txt, fecha: new Date(), lote: currentLoteName
        }, { merge: true }).then(() => {
            indicador.textContent = "‚úÖ Guardado";
            setTimeout(() => indicador.textContent = "", 2000);
        });
    }

    function borrarComentario() {
        const indicador = document.getElementById('saveIndicator');
        if(!currentId) return;
        if(confirm("¬øSeguro de eliminar esta observaci√≥n?")) {
            indicador.textContent = "Eliminando...";
            db.collection("observaciones").doc(currentId).delete().then(() => {
                document.getElementById('txtObs').value = "";
                indicador.textContent = "üóëÔ∏è Eliminado";
                setTimeout(() => indicador.textContent = "", 2000);
            });
        }
    }

    function cambiarEstadoLote(loteName, checkbox, type) {
        let updateData = {};
        if (type === 'main') {
            updateData = { terminado: checkbox.checked };
        } else if (type === 'int') {
            updateData = { terminado_int: checkbox.checked };
        }
        db.collection("estados_lotes").doc(loteName).set(updateData, { merge: true });
    }

    async function descargarReporteObservaciones() {
        const btn = document.getElementById('btnObsReport');
        const originalText = btn.textContent;
        btn.textContent = "‚è≥ ...";
        try {
            const snapshot = await db.collection("observaciones").get();
            if (snapshot.empty) { alert("No hay observaciones."); btn.textContent = originalText; return; }
            let csvContent = "data:text/csv;charset=utf-8,ID Protocolo,Lote,Comentario,Fecha\n"; 
            snapshot.forEach(doc => {
                const data = doc.data();
                const fecha = data.fecha ? data.fecha.toDate().toLocaleDateString() : "-";
                const comentarioSeguro = data.texto ? `"${data.texto.replace(/"/g, '""')}"` : "";
                csvContent += `${doc.id},${data.lote},${comentarioSeguro},${fecha}\n`;
            });
            downloadCSV(csvContent, "reporte_observaciones_v38.csv");
            btn.textContent = "‚úÖ Listo";
            setTimeout(() => btn.textContent = originalText, 2000);
        } catch (error) { console.error(error); alert("Error."); btn.textContent = originalText; }
    }

    function descargarReporteGeneral() {
        const btn = document.getElementById('btnGeneralReport');
        const originalText = btn.textContent;
        btn.textContent = "‚è≥ Generando...";

        let csvContent = "data:text/csv;charset=utf-8,Lote,Estado Protocolos,Estado INT,Total IDs,IDs con Obs,Detalle Observaciones\n";
        const lotes = Object.keys(lotesGlobal).sort();

        lotes.forEach(loteName => {
            const data = lotesGlobal[loteName];
            const estadoMain = data.terminado ? "TERMINADO" : "PENDIENTE";
            const estadoInt = data.terminado_int ? "TERMINADO" : "PENDIENTE";
            const totalIDs = data.items.length;
            const obsDelLote = obsData.filter(o => o.lote === loteName && o.texto && o.texto.trim() !== "");
            const cantObs = obsDelLote.length;
            let detalleObs = "";
            if (cantObs > 0) {
                const textos = obsDelLote.map(o => `[${o.id}: ${o.texto}]`);
                detalleObs = `"${textos.join('; ').replace(/"/g, '""')}"`;
            }
            csvContent += `${loteName},${estadoMain},${estadoInt},${totalIDs},${cantObs},${detalleObs}\n`;
        });

        downloadCSV(csvContent, "reporte_general_avance.csv");
        btn.textContent = "‚úÖ Listo";
        setTimeout(() => btn.textContent = originalText, 2000);
    }

    function downloadCSV(content, fileName) {
        const encodedUri = encodeURI(content);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", fileName);
        document.body.appendChild(link);
        link.click(); document.body.removeChild(link);
    }

    function descargarListaLote() {
        if(!currentViewLote) return;
        const items = lotesGlobal[currentViewLote].items;
        let csvContent = "data:text/csv;charset=utf-8,Posicion,ID Protocolo\n";
        items.forEach((item, index) => { csvContent += `${index + 1},${item.id_bct}\n`; });
        downloadCSV(csvContent, `Lista_${currentViewLote}.csv`);
    }

    function generarTablaResumen() {
        const tbody = document.getElementById('summaryTableBody');
        let html = '';
        const nombresLotes = Object.keys(lotesGlobal).sort();
        nombresLotes.forEach(nombre => {
            const data = lotesGlobal[nombre];
            const items = data.items;
            const primero = items.length > 0 ? items[0].id_bct : "-";
            const ultimo = items.length > 0 ? items[items.length-1].id_bct : "-";
            
            const checkedMain = data.terminado ? "checked" : "";
            const checkedInt = data.terminado_int ? "checked" : ""; 
            const rowClass = data.terminado ? "row-finished-main" : "";
            
            const obsCount = obsData.filter(o => o.lote === nombre && o.texto && o.texto.trim() !== "").length;
            let obsButton = `<span class="obs-badge">0</span>`;
            if (obsCount > 0) obsButton = `<button class="btn-obs-active" onclick="verObservaciones('${nombre}')">${obsCount} üëÅÔ∏è</button>`;

            html += `<tr class="${rowClass}">
                <td class="status-cell">
                    <div class="switch">
                        <label class="switch">
                            <input type="checkbox" ${checkedMain} onclick="cambiarEstadoLote('${nombre}', this, 'main')">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <span class="switch-label" style="display:${data.terminado ? 'block':'none'}">LISTO</span>
                </td>
                <td class="status-cell">
                    <div class="switch">
                        <label class="switch">
                            <input type="checkbox" class="int-check" ${checkedInt} onclick="cambiarEstadoLote('${nombre}', this, 'int')">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <span class="switch-label int-label" style="display:${data.terminado_int ? 'block':'none'}">LISTO</span>
                </td>
                <td><b>${nombre}</b></td>
                <td class="cell-id">${primero}</td>
                <td class="cell-id">${ultimo}</td>
                <td style="text-align:center;">${items.length}</td>
                <td style="text-align:center;">${obsButton}</td>
                <td><button class="btn-mini" onclick="verLista('${nombre}')">Ver IDs</button></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function parseDate(dateStr) {
        if (!dateStr) return new Date(0);
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        return new Date(dateStr);
    }

    function toggleSortDate() {
        sortState = (sortState + 1) % 5;
        const btn = document.getElementById('btnSortDate');
        if (sortState === 0) { btn.textContent = "üìÖ Orden Original"; btn.classList.remove('active-sort'); }
        else if (sortState === 1) { btn.textContent = "üìÖ Fecha: Menor ‚ûî Mayor"; btn.classList.add('active-sort'); }
        else if (sortState === 2) { btn.textContent = "üî§ ID: Menor ‚ûî Mayor"; btn.classList.add('active-sort'); }
        else if (sortState === 3) { btn.textContent = "üî§ ID: Mayor ‚ûî Menor"; btn.classList.add('active-sort'); }
        else if (sortState === 4) { btn.textContent = "üîÑ Original Invertido"; btn.classList.add('active-sort'); }
        if (currentViewLote) verLista(currentViewLote);
    }

    function verLista(nombre) {
        currentViewLote = nombre;
        document.getElementById('viewTable').style.display = 'none';
        document.getElementById('viewList').style.display = 'flex';
        document.getElementById('modalTitle').textContent = "üìÇ " + nombre;
        document.getElementById('btnGeneralReport').style.display = 'none';
        document.getElementById('btnObsReport').style.display = 'none';
        document.getElementById('btnDownloadLote').style.display = 'flex';
        document.getElementById('btnSortDate').style.display = 'flex';
        
        const container = document.getElementById('flowContainer');
        container.innerHTML = ""; // Limpiar
        
        let items = [...lotesGlobal[nombre].items];
        items = items.map((item, idx) => { return { ...item, originalIndex: idx + 1 }; });

        if (sortState === 1) items.sort((a, b) => parseDate(a["Fecha Alta"]) - parseDate(b["Fecha Alta"]));
        else if (sortState === 2) items.sort((a, b) => a.id_bct.localeCompare(b.id_bct, undefined, {numeric: true}));
        else if (sortState === 3) items.sort((a, b) => b.id_bct.localeCompare(a.id_bct, undefined, {numeric: true}));
        else if (sortState === 4) items.sort((a, b) => b.originalIndex - a.originalIndex);

        let html = '';
        items.forEach(item => {
            const fechaTxt = item["Fecha Alta"] ? item["Fecha Alta"] : "S/F";
            html += `
            <div class="flow-row" 
                 onmousedown="startPaint(this)" 
                 onmouseenter="paintIfDragging(this)"
                 onclick="toggleCheck(this)">
                <div class="flow-pos">#${item.originalIndex}</div>
                <div class="flow-id">${item.id_bct}</div>
                <div class="flow-date">${fechaTxt}</div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function startPaint(element) { isDragging = true; markRow(element); }
    function paintIfDragging(element) { if (isDragging) markRow(element); }
    function toggleCheck(element) {}
    function markRow(element) { element.classList.add('checked'); }

    function verObservaciones(nombre) {
        currentViewLote = null;
        document.getElementById('viewTable').style.display = 'none';
        document.getElementById('viewList').style.display = 'flex';
        document.getElementById('modalTitle').textContent = "‚ö†Ô∏è Obs: " + nombre;
        document.getElementById('btnGeneralReport').style.display = 'none';
        document.getElementById('btnObsReport').style.display = 'none';
        document.getElementById('btnDownloadLote').style.display = 'none';
        document.getElementById('btnSortDate').style.display = 'none';
        
        const container = document.getElementById('flowContainer');
        container.innerHTML = ""; // Limpiar
        
        const items = lotesGlobal[nombre].items;
        let html = '';
        let count = 0;
        items.forEach((item, idx) => {
            const obs = obsData.find(o => o.id === item.id_bct && o.texto && o.texto.trim() !== "");
            if (obs) {
                count++;
                html += `<div class="obs-card">
                    <div class="obs-card-header"><span class="obs-id-title">${item.id_bct}</span><span class="obs-pos">Pos: #${idx+1}</span></div>
                    <div class="obs-text">${obs.texto}</div>
                </div>`;
            }
        });
        if (count === 0) html = "<div style='color:white; padding:20px;'>Error: No se encontraron los datos.</div>";
        container.innerHTML = html;
    }

    function toggleSummary() { document.getElementById('summaryModal').style.display = 'flex'; backToTable(); }
    function closeModal() { document.getElementById('summaryModal').style.display = 'none'; }
    function backToTable() { 
        document.getElementById('viewTable').style.display = 'block'; 
        document.getElementById('viewList').style.display = 'none'; 
        document.getElementById('modalTitle').textContent = "Resumen";
        document.getElementById('btnGeneralReport').style.display = 'flex';
        document.getElementById('btnObsReport').style.display = 'flex';
    }
    window.onclick = (e) => { if (e.target == document.getElementById('summaryModal')) closeModal(); }

</script>

</body>
</html>
